# =======================================================
# GitHub Actions CI Pipeline for Python (pytest)
# -------------------------------------------------------
# This workflow automatically runs all pytest test cases
# in the 'tests/' directory on every push and pull request
# targeting the 'main' branch. It is production-ready,
# includes error handling, reporting, and documentation.
# =======================================================

name: CI Pipeline

description: >
  Production-grade CI workflow for Python codebase using pytest. Runs on every push and pull request to main. Installs dependencies, executes tests, fails on errors, and produces actionable output.

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    name: Run Pytest on Python 3.10
    runs-on: ubuntu-latest

    steps:
      # --- Step 1: Checkout code ---
      - name: Checkout repository
        uses: actions/checkout@v4

      # --- Step 2: Set up Python 3.10 ---
      - name: Set up Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      # --- Step 3: Install dependencies ---
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; else pip install pytest; fi

      # --- Step 4: Run pytest ---
      - name: Run tests with pytest
        run: pytest tests --maxfail=1 --disable-warnings --tb=short

      # --- Step 5: Upload test results (optional, for reporting) ---
      - name: Upload pytest results (if any)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pytest-results
          path: .pytest_cache
          if-no-files-found: ignore

    # --- Error handling: The job fails if any test fails (default behavior) ---
    # --- GitHub UI will display failed jobs and logs for troubleshooting ---

# =======================================================
# TROUBLESHOOTING GUIDE
# -------------------------------------------------------
# - If the workflow fails on 'Install dependencies', check requirements.txt for errors.
# - If pytest fails, review the test logs in the Actions tab for stack traces.
# - To debug, add 'print' statements or use 'pytest --maxfail=1 -v' for verbose output.
# - For dependency issues, ensure all required packages are listed in requirements.txt.
#
# =======================================================
# OPTIMIZATION & SCALABILITY RECOMMENDATIONS
# -------------------------------------------------------
# - For large test suites, consider parallel jobs or matrix builds (see 'strategy.matrix').
# - Use pytest plugins for coverage (pytest-cov) and reporting (junitxml).
# - Cache dependencies for faster builds (actions/cache).
# - Integrate code quality/linting as separate jobs.
#
# For further customization, refer to: https://docs.github.com/en/actions
# =======================================================
